<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Backend API Tester</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f3f3f3;
      }

      h1 {
        color: #333;
      }

      .section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      input,
      button {
        padding: 10px;
        margin: 5px 0;
        width: calc(100% - 22px);
        border-radius: 4px;
        border: 1px solid #ddd;
        font-size: 16px;
      }

      button {
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
      }

      button:hover {
        background-color: #0056b3;
      }

      .result {
        margin-top: 10px;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 4px;
        border: 1px solid #ddd;
        font-size: 14px;
        white-space: pre-wrap;
      }

      .media-feed {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }

      .media-item {
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        background: white;
        width: 300px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      }

      video {
        width: 100%;
        border-radius: 8px;
      }

      .media-item h4 {
        margin: 0 0 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>Backend API Tester</h1>

    <!-- User Registration Section -->
    <div class="section">
      <h3>Register User</h3>
      <input type="text" id="register-username" placeholder="Username" />
      <input type="email" id="register-email" placeholder="Email" />
      <input type="password" id="register-password" placeholder="Password" />
      <button onclick="registerUser()">Register</button>
      <div id="register-result" class="result"></div>
    </div>

    <!-- Login User Section -->
    <div class="section">
      <h3>Login User</h3>
      <input type="email" id="login-email" placeholder="Email" />
      <input type="password" id="login-password" placeholder="Password" />
      <button onclick="loginUser()">Login</button>
      <div id="login-result" class="result"></div>

      <!-- 2FA Section -->
      <div id="two-fa-section" style="display: none">
        <input type="text" id="two-fa-token" placeholder="Enter 2FA Code" />
        <button onclick="verifyTwoFactor()">Verify 2FA Code</button>
        <div id="two-fa-result" class="result"></div>
      </div>
    </div>

    <!-- Enable/Disable 2FA Section -->
    <div class="section">
      <h3>Enable/Disable 2FA</h3>
      <button onclick="toggleTwoFactor()">Toggle 2FA</button>
      <div id="toggle-2fa-result" class="result"></div>
    </div>

    <!-- Verify Email Section -->
    <div class="section">
      <h3>Verify Email</h3>
      <input
        type="text"
        id="verification-token"
        placeholder="Verification Token"
      />
      <button onclick="verifyEmail()">Verify Email</button>
      <div id="verify-email-result" class="result"></div>
    </div>

    <!-- Fetch User Details Section -->
    <div class="section">
      <h3>Fetch User Details</h3>
      <button onclick="fetchUserDetails()">Fetch Details</button>
      <div id="fetch-user-result" class="result"></div>
    </div>

    <!-- Edit User Profile Section -->
    <div class="section">
      <h3>Edit User Profile</h3>
      <input type="text" id="edit-username" placeholder="New Username" />
      <input type="email" id="edit-email" placeholder="New Email" />
      <button onclick="editUserProfile()">Edit Profile</button>
      <div id="edit-profile-result" class="result"></div>
    </div>

    <!-- Change Password Section -->
    <div class="section">
      <h3>Change Password</h3>
      <input type="password" id="old-password" placeholder="Old Password" />
      <input type="password" id="new-password" placeholder="New Password" />
      <button onclick="changePassword()">Change Password</button>
      <div id="change-password-result" class="result"></div>
    </div>

    <!-- Reset Password Section -->
    <div class="section">
      <h3>Reset Password</h3>
      <input
        type="email"
        id="reset-email"
        placeholder="Email for Password Reset"
      />
      <button onclick="requestPasswordReset()">Request Password Reset</button>
      <div id="reset-password-result" class="result"></div>

      <input type="text" id="reset-token" placeholder="Reset Token" />
      <input
        type="password"
        id="reset-new-password"
        placeholder="New Password"
      />
      <button onclick="resetPassword()">Reset Password</button>
      <div id="complete-reset-result" class="result"></div>
    </div>

    <!-- Video Upload Section -->
    <div class="section">
      <h3>Upload Video</h3>
      <input type="text" id="video-title" placeholder="Video Title" />
      <input
        type="text"
        id="video-description"
        placeholder="Video Description"
      />
      <input type="file" id="video-file" accept="video/*" />
      <button onclick="uploadVideo()">Upload Video</button>
      <div id="upload-video-result" class="result"></div>
    </div>

    <!-- Get Feed Section -->
    <div class="section">
      <h3>Get Media Feed</h3>
      <button onclick="getFeed()">Get Feed</button>
      <div id="feed-result" class="result"></div>
      <div id="media-feed" class="media-feed"></div>
    </div>

    <script>
      const baseUrl = "http://localhost:5000/api"; // Adjust this to your backend's base URL
      let token = ""; // Store JWT token after successful login

      // Utility function to handle API responses and display results
      function displayResult(elementId, result) {
        document.getElementById(elementId).innerText = JSON.stringify(
          result,
          null,
          2
        );
      }

      // Utility function to display media feed
      function displayFeed(mediaItems) {
        const feedContainer = document.getElementById("media-feed");
        feedContainer.innerHTML = ""; // Clear previous content

        if (!Array.isArray(mediaItems)) {
          displayResult("feed-result", {
            error: "Media items is not an array",
          });
          return;
        }

        mediaItems.forEach((item) => {
          const mediaElement = document.createElement("div");
          mediaElement.className = "media-item";

          mediaElement.innerHTML = `
      <h4>${item.title}</h4>
      <p>${item.description}</p>
      <video controls>
        <source src="http://localhost:5000/${item.videoUrl}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <p>Uploaded by: ${item.user?.username || "Unknown"}</p>
    `;

          feedContainer.appendChild(mediaElement);
        });
      }

      // Register User Function
      async function registerUser() {
        const username = document.getElementById("register-username").value;
        const email = document.getElementById("register-email").value;
        const password = document.getElementById("register-password").value;

        const response = await fetch(`${baseUrl}/users/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, email, password }),
        });

        const result = await response.json();
        displayResult("register-result", result);
      }

      // Login User Function
      async function loginUser() {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;

        const response = await fetch(`${baseUrl}/users/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });

        const result = await response.json();

        if (
          result.message ===
          "2FA code sent to your email. Please enter the code to proceed."
        ) {
          document.getElementById("two-fa-section").style.display = "block";
        } else if (result.token) {
          token = result.token; // Store the token
          displayResult("login-result", { message: "Login successful" });
        } else {
          displayResult("login-result", result);
        }
      }

      // Verify 2FA Function
      async function verifyTwoFactor() {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        const twoFactorToken = document.getElementById("two-fa-token").value;

        const response = await fetch(`${baseUrl}/users/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password, twoFactorToken }), // Include twoFactorToken
        });

        const result = await response.json();
        if (result.token) {
          token = result.token; // Store the token
          displayResult("two-fa-result", {
            message: "2FA verification successful",
          });
        } else {
          displayResult("two-fa-result", result);
        }
      }

      // Toggle 2FA Function
      async function toggleTwoFactor() {
        const response = await fetch(`${baseUrl}/users/toggle-2fa`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });

        const result = await response.json();
        displayResult("toggle-2fa-result", result);
      }

      // Verify Email Function
      async function verifyEmail() {
        const token = document.getElementById("verification-token").value;

        const response = await fetch(`${baseUrl}/users/verify-email/${token}`, {
          method: "GET",
        });

        const result = await response.json();
        displayResult("verify-email-result", result);
      }

      // Fetch User Details Function
      async function fetchUserDetails() {
        const response = await fetch(`${baseUrl}/users/profile`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });

        const result = await response.json();
        displayResult("fetch-user-result", result);
      }

      // Edit User Profile Function
      async function editUserProfile() {
        const newUsername = document.getElementById("edit-username").value;
        const newEmail = document.getElementById("edit-email").value;

        const response = await fetch(`${baseUrl}/users/profile`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ username: newUsername, email: newEmail }),
        });

        const result = await response.json();
        displayResult("edit-profile-result", result);
      }

      // Change Password Function
      async function changePassword() {
        const oldPassword = document.getElementById("old-password").value;
        const newPassword = document.getElementById("new-password").value;

        const response = await fetch(`${baseUrl}/users/change-password`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ oldPassword, newPassword }),
        });

        const result = await response.json();
        displayResult("change-password-result", result);
      }

      // Request Password Reset Function
      async function requestPasswordReset() {
        const email = document.getElementById("reset-email").value;

        const response = await fetch(
          `${baseUrl}/users/request-reset-password`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          }
        );

        const result = await response.json();
        displayResult("reset-password-result", result);
      }

      // Reset Password Function
      async function resetPassword() {
        const resetToken = document.getElementById("reset-token").value;
        const newPassword = document.getElementById("reset-new-password").value;

        const response = await fetch(
          `${baseUrl}/users/reset-password/${resetToken}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ newPassword }),
          }
        );

        const result = await response.json();
        displayResult("complete-reset-result", result);
      }

      // Upload Video Function
      async function uploadVideo() {
        const title = document.getElementById("video-title").value;
        const description = document.getElementById("video-description").value;
        const fileInput = document.getElementById("video-file");
        const file = fileInput.files[0];

        if (!file) {
          displayResult("upload-video-result", {
            error: "Please select a video file to upload.",
          });
          return;
        }

        const formData = new FormData();
        formData.append("title", title);
        formData.append("description", description);
        formData.append("video", file);

        const response = await fetch(`${baseUrl}/videos/upload`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
          },
          body: formData,
        });

        const result = await response.json();
        displayResult("upload-video-result", result);
      }

      // Get Feed Function
      async function getFeed() {
        const response = await fetch(`${baseUrl}/feed`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });

        const result = await response.json();

        if (response.ok) {
          if (Array.isArray(result)) {
            displayFeed(result); // Pass media items to display function if it's an array
          } else {
            displayResult("feed-result", {
              error: "Unexpected response format: expected an array.",
            });
          }
        } else {
          displayResult("feed-result", result);
        }
      }
    </script>
  </body>
</html>
